"use strict";var w=Object.defineProperty;var L=Object.getOwnPropertyDescriptor;var U=Object.getOwnPropertyNames;var D=Object.prototype.hasOwnProperty;var _=(e,t)=>{for(var r in t)w(e,r,{get:t[r],enumerable:!0})},v=(e,t,r,n)=>{if(t&&typeof t=="object"||typeof t=="function")for(let o of U(t))!D.call(e,o)&&o!==r&&w(e,o,{get:()=>t[o],enumerable:!(n=L(t,o))||n.enumerable});return e};var B=e=>v(w({},"__esModule",{value:!0}),e);var j={};_(j,{default:()=>K});module.exports=B(j);var c=require("@raycast/api"),g=require("react");var m=require("react");var l=require("@raycast/api"),T=require("child_process"),O=require("util");function E(e){return!Number.isNaN(Number(e))}var I="https://www.raycast.com/lucaschultz/port-manager";var R=(0,O.promisify)(T.exec),d=class{constructor(t,r,n,o,s,u,b,i){this.pid=t;this.name=r;this.parentPid=n;this.user=o;this.uid=s;this.protocol=u;this.portInfo=b;this.internetProtocol=i}async getProcessPath(t,r){let n=`${r?"/usr/bin/sudo ":""}/bin/ps -p ${t} -o comm=`,{stdout:o,stderr:s}=await R(n);if(s)throw new Error(s);return o.replace(`
`,"")}async loadPath(){this.path=await this.getProcessPath(this.pid,d.useSudo)}async loadParentPath(){this.parentPid!==void 0&&(this.parentPath=await this.getProcessPath(this.parentPid,d.useSudo))}static async getCurrent(){let t=`${d.useSudo?"/usr/bin/sudo ":""}/usr/sbin/lsof +c0 -iTCP -w -sTCP:LISTEN -P -FpcRuLPn`;try{let{stdout:r,stderr:n}=await R(t);if(n)throw new Error(n);let o=r.split(`
p`),s=[];for(let u of o){if(u.length===0)continue;let b=u.split(`
`),i={pid:0};for(let h of b){if(h.length===0)continue;let S=h[0],a=h.slice(1);if(a.length!==0)switch(S){case"p":i.pid=Number(a);break;case"c":i.name=a;break;case"R":i.parentPid=Number(a);break;case"L":i.user=a;break;case"u":i.uid=Number(a);break;case"P":i.protocol=a;break;case"n":i.portInfo?i.portInfo.push({host:a.split(":")[0],port:Number(a.split(":")[1])}):i.portInfo=[{host:a.split(":")[0],port:Number(a.split(":")[1])}];break;case"t":i.internetProtocol=a;break;default:E(S)&&(i.pid=+`${S}${a}`);break}}let p=new d(i.pid,i.name,i.parentPid,i.user,i.uid,i.protocol,i.portInfo);await p.loadPath(),await p.loadParentPath(),s.push(p)}return s}catch(r){throw r instanceof Error&&r.message.includes("sudo: a terminal is required to read the password")&&(await(0,l.confirmAlert)({title:"Can't Use Sudo",message:"It seems your user can't use sudo without a password. Please turn off using sudo in the extension preferences or change your sudo configuration.",primaryAction:{title:"Learn More"},dismissAction:{title:"Close Raycast"}})?(await(0,l.open)(I),await(0,l.closeMainWindow)()):await(0,l.closeMainWindow)()),r}}},f=d;f.useSudo=(0,l.getPreferenceValues)().sudo??!1;function k(){let[e,t]=(0,m.useState)([]),r=(0,m.useCallback)(async()=>{let n=await f.getCurrent();t(n)},[t]);return(0,m.useEffect)(()=>{(async()=>r())()},[]),[e,r]}var C=require("child_process"),A=require("util"),x=(0,A.promisify)(C.exec),y={HUP:"1",INT:"2",QUIT:"3",ABRT:"6",KILL:"9",ALRM:"14",TERM:"15"};async function N(e,t,r){let n=e instanceof Array?e.join(" "):e,o=`${r?"/usr/bin/sudo /bin/kill":"kill"} -${t} ${n}`,{stderr:s}=await x(o);if(s)throw new Error(s)}async function F(e,t,r){let n=e instanceof Array?e.map(u=>`'${u}'`).join(" "):`'${e}'`,o=`${r?"/usr/bin/sudo ":""}/usr/bin/killall -${t} ${n}`,{stderr:s}=await x(o);if(s)throw new Error(s)}async function M(e,t){let{killSignal:r=y.TERM,useSudo:n=!1,killAll:o=!1,killParent:s=!1,onError:u,onKilled:b}=t??{},i=async()=>{if(o){if(e.name===void 0)throw new Error("Can't use killall because process name is undefined");await F(e.name,r,n);return}if(s){if(e.parentPid===void 0)throw new Error("Can't kill parent because parent pid is undefined");await N(e.parentPid,r,n);return}await N(e.pid,r,n)};try{await i(),b&&b()}catch(p){console.log(p),u&&u(p)}}var P=require("react/jsx-runtime");function H(e,t){return e.filter((r,n,o)=>o.findIndex(s=>s[t]===r[t])===n)}var $=(0,c.getPreferenceValues)();function K(){let[e,t]=k(),r=V(e.length===0,1e3),n=H(e.filter(o=>o.portInfo!==void 0&&o.portInfo.length>0).flatMap(o=>o.portInfo.map(s=>({port:`${s.port}`,process:o}))),"port");return(0,P.jsx)(c.MenuBarExtra,{isLoading:r,icon:{source:{light:"menu-bar-icon-light.png",dark:"menu-bar-icon-dark.png"}},children:n.map(o=>(0,P.jsx)(c.MenuBarExtra.Submenu,{title:o.port,children:(0,P.jsx)(c.MenuBarExtra.Section,{title:o.process.name??"Untitled Process",children:(0,P.jsx)(c.MenuBarExtra.Item,{title:"Kill",onAction:async()=>{await M(o.process,{onError(){(0,c.showHUD)("\u26A0\uFE0F Failed to kill process")},onKilled(){t()},killSignal:$.killSignal==="ask"?y.TERM:$.killSignal})}})})},o.port))})}function V(e,t){let[r,n]=(0,g.useState)(e);return(0,g.useEffect)(()=>{if(e){n(!0);let o=setTimeout(()=>{n(!1)},t);return()=>clearTimeout(o)}},[e,t]),r}
